#!/bin/bash
# ç®€æ´çš„è®°å¿†ä¿å­˜å‘½ä»¤
# ä½¿ç”¨æ–¹æ³•: memory-remember "æ ‡é¢˜" "å†…å®¹" [--type TYPE] [--importance N] [--tags "tag1,tag2"]

cd "/root/code/claude-memory-system"
source .venv/bin/activate

TITLE=""
CONTENT=""
MEMORY_TYPE="semantic"
IMPORTANCE="5.0"
TAGS=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --type)
            MEMORY_TYPE="$2"
            shift 2
            ;;
        --importance)
            IMPORTANCE="$2"
            shift 2
            ;;
        --tags)
            TAGS="$2"
            shift 2
            ;;
        *)
            if [ -z "$TITLE" ]; then
                TITLE="$1"
            elif [ -z "$CONTENT" ]; then
                CONTENT="$1"
            fi
            shift
            ;;
    esac
done

if [ -z "$TITLE" ] || [ -z "$CONTENT" ]; then
    echo "âŒ ç”¨æ³•: memory-remember \"æ ‡é¢˜\" \"å†…å®¹\" [--type TYPE] [--importance N] [--tags \"tag1,tag2\"]"
    echo "ç±»å‹: semantic|episodic|procedural|working (é»˜è®¤:semantic)"
    echo "é‡è¦æ€§: 1-10 (é»˜è®¤:5.0)"
    echo "ç¤ºä¾‹: memory-remember \"Pythonä¼˜åŒ–\" \"ä½¿ç”¨ç¼“å­˜æå‡æ€§èƒ½\" --type semantic --importance 8.0 --tags \"Python,æ€§èƒ½\""
    exit 1
fi

# å°†æ ‡ç­¾å†™å…¥ä¸´æ—¶æ–‡ä»¶
TEMP_TAGS_FILE="/tmp/memory_tags_$$"
if [ -n "$TAGS" ]; then
    echo "$TAGS" | tr ',' '\n' > "$TEMP_TAGS_FILE"
else
    echo "" > "$TEMP_TAGS_FILE"
fi

python3 -c "
import sys
sys.path.insert(0, '.')
from claude_memory import MemoryManager
from claude_memory.models.memory import MemoryType
from pathlib import Path

try:
    memory = MemoryManager(Path('..'))
    
    # è¯»å–æ ‡ç­¾
    tags = []
    try:
        with open('$TEMP_TAGS_FILE', 'r', encoding='utf-8') as f:
            tags = [line.strip() for line in f if line.strip()]
    except:
        tags = []
    
    memory_id = memory.remember(
        content='''$CONTENT''',
        title='''$TITLE''',
        memory_type=MemoryType('$MEMORY_TYPE'),
        importance=float('$IMPORTANCE'),
        tags=tags
    )
    
    print('âœ… è®°å¿†ä¿å­˜æˆåŠŸ!')
    print(f'ğŸ“ æ ‡é¢˜: $TITLE')
    print(f'ğŸ“„ å†…å®¹: $CONTENT')
    print(f'ğŸ·ï¸ ç±»å‹: $MEMORY_TYPE')
    print(f'â­ é‡è¦æ€§: $IMPORTANCE/10')
    if tags:
        print(f'ğŸ”– æ ‡ç­¾: {\"ã€\".join(tags)}')
    print(f'ğŸ†” è®°å¿†ID: {memory_id[:8]}...')
    
except Exception as e:
    print(f'âŒ ä¿å­˜å¤±è´¥: {e}')
    exit(1)
finally:
    import os
    try:
        os.remove('$TEMP_TAGS_FILE')
    except:
        pass
"