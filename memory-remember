#!/bin/bash
# 简洁的记忆保存命令
# 使用方法: memory-remember "标题" "内容" [--type TYPE] [--importance N] [--tags "tag1,tag2"]

cd "/root/code/claude-memory-system"
source .venv/bin/activate

TITLE=""
CONTENT=""
MEMORY_TYPE="semantic"
IMPORTANCE="5.0"
TAGS=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --type)
            MEMORY_TYPE="$2"
            shift 2
            ;;
        --importance)
            IMPORTANCE="$2"
            shift 2
            ;;
        --tags)
            TAGS="$2"
            shift 2
            ;;
        *)
            if [ -z "$TITLE" ]; then
                TITLE="$1"
            elif [ -z "$CONTENT" ]; then
                CONTENT="$1"
            fi
            shift
            ;;
    esac
done

if [ -z "$TITLE" ] || [ -z "$CONTENT" ]; then
    echo "❌ 用法: memory-remember \"标题\" \"内容\" [--type TYPE] [--importance N] [--tags \"tag1,tag2\"]"
    echo "类型: semantic|episodic|procedural|working (默认:semantic)"
    echo "重要性: 1-10 (默认:5.0)"
    echo "示例: memory-remember \"Python优化\" \"使用缓存提升性能\" --type semantic --importance 8.0 --tags \"Python,性能\""
    exit 1
fi

# 将标签写入临时文件
TEMP_TAGS_FILE="/tmp/memory_tags_$$"
if [ -n "$TAGS" ]; then
    echo "$TAGS" | tr ',' '\n' > "$TEMP_TAGS_FILE"
else
    echo "" > "$TEMP_TAGS_FILE"
fi

python3 -c "
import sys
sys.path.insert(0, '.')
from claude_memory import MemoryManager
from claude_memory.models.memory import MemoryType
from pathlib import Path

try:
    memory = MemoryManager(Path('..'))
    
    # 读取标签
    tags = []
    try:
        with open('$TEMP_TAGS_FILE', 'r', encoding='utf-8') as f:
            tags = [line.strip() for line in f if line.strip()]
    except:
        tags = []
    
    memory_id = memory.remember(
        content='''$CONTENT''',
        title='''$TITLE''',
        memory_type=MemoryType('$MEMORY_TYPE'),
        importance=float('$IMPORTANCE'),
        tags=tags
    )
    
    print('✅ 记忆保存成功!')
    print(f'📝 标题: $TITLE')
    print(f'📄 内容: $CONTENT')
    print(f'🏷️ 类型: $MEMORY_TYPE')
    print(f'⭐ 重要性: $IMPORTANCE/10')
    if tags:
        print(f'🔖 标签: {\"、\".join(tags)}')
    print(f'🆔 记忆ID: {memory_id[:8]}...')
    
except Exception as e:
    print(f'❌ 保存失败: {e}')
    exit(1)
finally:
    import os
    try:
        os.remove('$TEMP_TAGS_FILE')
    except:
        pass
"